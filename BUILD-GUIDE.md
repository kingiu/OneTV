# OneTV 应用构建指南

## 构建流程概述

为了确保 OneTV 应用的正常构建和语音功能的稳定运行，我们采用了规范的 Expo 构建流程。本指南将详细介绍构建脚本的使用方法和注意事项。

## 构建脚本说明

### 1. 正式版构建脚本

**文件**：`build-release.sh`
**用途**：构建正式版（release）应用并安装到设备
**执行流程**：
1. 检查依赖环境
2. 检查设备连接
3. 运行 `prebuild` 生成原生文件
4. 构建 release 版本
5. 安装到指定设备
6. 清理临时文件

**使用方法**：
```bash
# 直接运行脚本
./build-release.sh

# 或指定设备 IP
DEVICE_IP="192.168.100.247" ./build-release.sh
```

### 2. 开发版构建脚本

**文件**：`build-debug.sh`
**用途**：构建开发版（debug）应用并直接运行
**执行流程**：
1. 检查依赖环境
2. 检查设备连接
3. 运行 `prebuild` 生成原生文件
4. 运行 debug 版本（启动 Metro 服务器）

**使用方法**：
```bash
# 直接运行脚本
./build-debug.sh

# 或指定设备 IP
DEVICE_IP="192.168.100.247" ./build-debug.sh
```

## 构建注意事项

### 1. 核心原则

**必须遵循的构建顺序**：
- ✅ 正确：`prebuild` → `run:android`
- ❌ 错误：直接 `run:android` 跳过 `prebuild`

**原因**：
- 语音功能依赖自定义原生插件 `withXiajieVoice`
- 该插件需要通过 `prebuild` 生成原生 Java 文件
- 跳过 `prebuild` 会导致语音功能失效

### 2. 常见问题及解决方案

**问题**：构建失败，提示 "Unresolved reference: modules"
**解决方案**：确保已运行 `prebuild` 生成 `modules/voiceai` 目录

**问题**：语音功能失效，无相关日志
**解决方案**：
1. 检查 `MainApplication.kt` 中是否已注册 `AIVoicePackage`
2. 确保已运行 `prebuild` 生成所有必要的原生文件
3. 查看 `adb logcat` 中的相关日志

**问题**：设备无法连接
**解决方案**：
1. 检查设备 IP 是否正确
2. 确保设备已开启 USB 调试
3. 尝试重新连接：`adb connect 192.168.100.247`

### 3. 日志查看

构建过程中，您可以通过以下命令查看设备日志，特别是语音相关的日志：

```bash
# 查看所有语音相关日志
adb -s 192.168.100.247 logcat | grep -i voice

# 查看 aivoice 相关日志
adb -s 192.168.100.247 logcat | grep -i aivoice

# 查看错误和异常日志
adb -s 192.168.100.247 logcat -v time | grep -i -E 'error|exception|crash'
```

## 环境要求

### 1. 开发环境

- Node.js ≥ 16.x
- npm ≥ 8.x 或 yarn ≥ 1.22.x
- Android SDK（包含 adb 工具）
- Expo CLI ≥ 6.x

### 2. 设备要求

- Android TV 或机顶盒设备
- 已开启 USB 调试
- 与开发机器在同一局域网

## 最佳实践

1. **定期更新依赖**：
   ```bash
   npx expo update
   ```

2. **检查项目健康状态**：
   ```bash
   npx expo doctor
   ```

3. **使用版本控制**：
   - 将构建脚本添加到版本控制中
   - 不要将 `android/` 和 `ios/` 目录添加到版本控制（由 `prebuild` 生成）

4. **代码审查**：
   - 确保 `withXiajieVoice` 插件配置正确
   - 检查 `MainApplication.kt` 中的原生模块注册

## 构建流程示意图

```
┌─────────────────────────────────────────────────┐
│  开始构建                                       │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  1. 检查依赖环境                                │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  2. 检查设备连接                                │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  3. 运行 prebuild 生成原生文件                  │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  4. 构建应用 (release/debug)                    │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  5. 安装/运行应用                               │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  6. 清理临时文件                                │
└─────────────────┬───────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────┐
│  构建完成                                       │
└─────────────────────────────────────────────────┘
```

## 联系方式

如果您在构建过程中遇到问题，请联系开发团队或查看项目文档。

---

**更新日期**：2026-01-05
**版本**：v1.0
**作者**：开发团队
